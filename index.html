<!doctype html>
<html>

<head>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="viewport"
    content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, minimal-ui, user-scalable=no" />
  <title>Virtual Controller</title>
  <link href="joydiv-skin-default.css" rel="stylesheet" />
  <style>
    html,
    body {
      -webkit-text-size-adjust: none;
      height: 100%;
      width: 100%;
      padding: 0;
    }

    body {
      margin: 0;
      -moz-box-sizing: border-box;
      box-sizing: border-box;
      background-color: gray;
      overflow: hidden;
    }

    .container {
      background-color: gray;
      display: flex;
      /* align-items: center; */
      justify-content: center;
      /* border:1px solid coral; */
      width: 100vw;
      height: 100%;
    }

    #joystick1 {
      width: 200px;
      height: 200px;
      font-size: 200px;
      margin: 10px;
      top: 40%;
    }

    /* Center Buttons */
    .center-btns{
      position: absolute;
      top:20%;
      height: 50px;
    }
    #main-button{
      width: 50px;
      height: 50px;
      padding:0;
      margin: 5px;
      border: none;
      background-color: transparent;
    }
    #main-button img{
      width: 50px;
      filter: invert(29%) sepia(57%) saturate(7093%) hue-rotate(349deg) brightness(102%) contrast(70%);
    }
    #start-button{
      position: relative;
      top: -40%;
      background-color: transparent;
      margin: 5px;
      padding:4px;
      border: 1px solid black;
      border-radius: 8px;
      font-size: medium;
      vertical-align: midde;
    }
    #back-button{
      position: relative;
      top: -40%;
      background-color: transparent;
      margin: 5px;
      padding:4px;
      border: 1px solid black;
      border-radius: 8px;
      font-size: medium;
    }

    #dpad {
      width: 100px;
      height: 100px;
      font-size: 100px;
      /* background-color: burlywood; */
      top: 60%;
      margin: 10px;
      opacity: 0.5;
    }

    /* XBOX buttons */
    .button-container {
      position: relative;
      width: 200px;
      height: 200px;
      top: 40%;
    }

    .button {
      border: solid 1px #ecf0f1;
      position: absolute;
      border-radius: 50%;
      background: none;
      font-size: 32px;
      height: 56px;
      width: 56px;
      padding: 0;
    }

    .xbox {
      display: flex;
      position: relative;
      /* right: 0%; top: 20%; */
      height: 200px;
      width: 200px;
    }

    #y-button {
      left: 72px;
      top: 20px;
      color: #fbc531;
    }

    #x-button {
      left: 20px;
      top: 72px;
      color: #1289A7;
    }

    #b-button {
      left: 124px;
      top: 72px;
      color: #e55039;
    }

    #a-button {
      left: 72px;
      top: 124px;
      color: #009432;
    }

    .unselectable {
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
  </style>

</head>

<body>
  <div class="container">
    <div id='joystick1' class="joydiv-controller unselectable">
      <div class="joydiv-up"></div>
      <div class="joydiv-left"></div>
      <div class="joydiv-right"></div>
      <div class="joydiv-down"></div>
      <div class="joydiv-trackpad">
        <div class="joydiv-tracker"></div>
      </div>
    </div>
    <div id='dpad' class="joydiv-controller">
      <div class="joydiv-up"></div>
      <div class="joydiv-left"></div>
      <div class="joydiv-right"></div>
      <div class="joydiv-down"></div>
      <div class="joydiv-trackpad">
        <div class="joydiv-tracker"></div>
      </div>
    </div>
    <div class="center-btns">
      <button id="back-button">BACK</button>
      <button id="main-button">
        <img src="xbox-logo.svg"></img>
      </button>
      <button id="start-button">START</button>
    </div>
    <div id='joystick2' class="joydiv-controller unselectable">
      <div class="joydiv-up"></div>
      <div class="joydiv-left"></div>
      <div class="joydiv-right"></div>
      <div class="joydiv-down"></div>
      <div class="joydiv-trackpad">
        <div class="joydiv-tracker"></div>
      </div>
    </div>
    <div class="button-container">
      <div class="xbox">
        <button class="button unselectable" id="y-button">Y</button>
        <button class="button unselectable" id="x-button">X</button>
        <button class="button unselectable" id="b-button">B</button>
        <button class="button unselectable" id="a-button">A</button>
      </div>
    </div>
  </div>
</body>
<script charset="UTF-8" src="joydiv.js"></script>
<script src="socket.io.js"></script>
<script type="text/javascript">

  var sock = io("http://192.168.2.92:8013");
  // Add prompt for ip j2dx server ip and port later?

  function send_input(key, value) {
    sock.emit('input', { "key": key, "value": value })
  }
  function createButton(id) {
    var button = document.getElementById(id);
    button.addEventListener('touchstart', function (e) {
      send_input(id, 1)
      e.preventDefault();
    }, false)
    button.addEventListener('touchend', function (e) {
      send_input(id, 0)
      e.preventDefault();
    }, false)
  }
  // Buttons
  createButton('y-button')
  createButton('x-button')
  createButton('a-button')
  createButton('b-button')

  createButton('main-button')
  createButton('back-button')
  createButton('start-button')

  // DPAD
  // Use JoyDiv with 8 direction input, and emit them accordingly. So instead of sending the x and y values, send button 0 or 1
  var dpad = document.getElementById('dpad');
  var dpadjdiv = new JoydivModule.Joydiv({ 'element': dpad })
  var dpad_down = {
    'up': 0,
    'down': 0,
    'left': 0,
    'right': 0
  };
  dpad.addEventListener('joydiv-changed', function (e) {
    var input = dpadjdiv.getOneOf8Directions();
    var dname = input.name;
    if (dname !== "none") {
      var dirs = dname.split('-');
      for (const [key, value] of Object.entries(dpad_down)) {
        if (dirs.includes(key)) {
          send_input(key + "-button", 1);
          dpad_down[key] = 1;
        } else if (value == 1) {
          send_input(key + "-button", 0);
          dpad_down[key] = 0;
        }
      }
    }

  });
  // DPAD Reset
  dpad.addEventListener('touchend', function (e) {
    for (var key in dpad_down) {
      dpad_down[key] = 0;
      send_input(key + "-button", 0);
    }
  });

  // Joysticks
  var j1 = document.getElementById('joystick1');
  var j2 = document.getElementById('joystick2');
  var joydiv1 = new JoydivModule.Joydiv({ 'element': j1, clampX: 1, clampY: 1, flipY: true });
  var joydiv2 = new JoydivModule.Joydiv({ 'element': j2, clampX: 1, clampY: 1, flipY: true });
  j1.addEventListener('joydiv-changed', function (e) {
    var offset = joydiv1.getOneDirection().offset;
    sock.emit('input', { 'key': 'left-stick-X', 'value': offset.x })
    sock.emit('input', { 'key': 'left-stick-Y', 'value': offset.y })
  });
  j2.addEventListener('joydiv-changed', function (e) {
    var offset = joydiv2.getOneDirection().offset;
    sock.emit('input', { 'key': 'right-stick-X', 'value': offset.x })
    sock.emit('input', { 'key': 'right-stick-Y', 'value': offset.y })
  });

  // Initialize virtual controller
  sock.emit("intro", { 'device': 'x360', 'id': 'x360', 'type': 'x360' })
  // Press the xbox button to initialize the controller!

  sock.on('disconnect', () => {
    document.getElementsByTagName('img')[0].style.filter = 'invert(29%) sepia(57%) saturate(7093%) hue-rotate(349deg) brightness(102%) contrast(70%)'
  });
  sock.on('connect', () => {
    document.getElementsByTagName('img')[0].style.filter = 'invert(18%) sepia(88%) saturate(5119%) hue-rotate(112deg) brightness(93%) contrast(90%)'
    setTimeout(()=>{document.getElementsByTagName('img')[0].style.filter="invert(0)"}, 5000)
  });
</script>

</html>